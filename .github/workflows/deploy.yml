name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ]

jobs:
  test-frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Validar Build do Frontend
        working-directory: ./frontend
        run: |
          npm ci
          npm run build

  test-backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, bcmath

      - name: Instalar Depend√™ncias Backend
        run: |
          composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist

  deploy:
    needs: [test-frontend, test-backend]
    runs-on: ubuntu-latest
    steps:
      - name: Executar Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          script: |
            set -e
            echo "üöÄ Iniciando Deploy na VPS..."

            cd /var/www/html/google-oauth-project
            git fetch --all
            git reset --hard origin/main
            git pull origin main

            echo "üêò Atualizando Backend..."
            export COMPOSER_ALLOW_SUPERUSER=1
            composer install --no-dev --optimize-autoloader
            php artisan migrate --force
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

            echo "üé® Atualizando Frontend..."
            cd frontend
            npm ci
            npm run build

            cd ..

            echo "üîí Ajustando permiss√µes finais..."
            chown -R www-data:www-data /var/www/html/google-oauth-project

            chmod -R 775 storage bootstrap/cache

            php artisan queue:restart

            sudo service nginx reload

            echo "‚úÖ Deploy Completo (Build local realizado)!"
